<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>운동 세트 관리</title>
  <link rel="stylesheet" type="text/css" th:href="@{/bootstrap.min.css}" />
  <link rel="stylesheet" type="text/css" th:href="@{/make_routine.css}" />
</head>

<body>
<!-- 네비게이션 바 -->
<nav th:replace="~{navbar :: navbarFragment}"></nav>

<!-- 메인 콘텐츠 -->
<div class="container mt-5">
  <div style="display: flex; justify-content: space-between; margin-bottom: 20px">
    <h1>새로운 루틴 만들기</h1>
    <button type="button" onclick="location.href='/workout/my_routine'">뒤로가기</button>
  </div>
  <form
          id="routine-form"
          action="/workout/make_routine"
          method="post"
          th:action="@{/workout/make_routine}"
          th:object="${routineUpdateDto}"
  >
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />

    <!--운동 컨테이너-->
    <div id="workout-container"></div>

    <table>
      <tr>
        <td>
          <input
                  type="submit"
                  id="saveWorkout"
                  class="btn btn-success"
                  value="저장"
                  style="display: none"
                  onclick="confirmRoutineName()"
          />
        </td>
      </tr>
    </table>
  </form>
</div>

<!-- 운동 선택 모달 -->
<div
        class="modal fade"
        id="workoutModal"
        tabindex="-1"
        aria-labelledby="workoutModalLabel"
        aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="workoutModalLabel">운동 선택</h5>
        <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>

<!-- 스크립트 -->
<script th:inline="javascript">
  let selectedWorkout = null; // 선택한 운동
  let workoutId = 0;

  // 모달 생성
  // function showWorkoutModal() {
  //   resetSelectedWorkout();
  //   const workoutModal = new bootstrap.Modal(document.getElementById('workoutModal'));
  //   workoutModal.show();
  // }

  // 모든 운동 항목에 클릭 이벤트 추가
  document.querySelectorAll('.tab-pane ul').forEach((ul) => {
    ul.querySelectorAll('li').forEach((item) => {
      item.addEventListener('click', function () {
        selectedWorkout = this.getAttribute('data-value') || this.innerText;
        confirmWorkout();
      });
    });
  });

  // 선택한 운동 추가
  function confirmWorkout() {
    // 운동을 선택하지 않을 경우 경고
    if (!selectedWorkout) {
      alert('운동을 선택하세요!');
      return;
    }

    workoutId++;
    const container = document.getElementById('workout-container');
    const newGroup = createWorkoutGroup(workoutId, selectedWorkout);
    container.appendChild(newGroup);
    addSet(newGroup.querySelector('.btn-add')); // 초기 세트 추가

    const workoutModal = bootstrap.Modal.getInstance(document.getElementById('workoutModal'));
    workoutModal.hide();

    updateSaveButtonVisibility(); // 저장 버튼의 표시 상태 업데이트
    updateSetDeleteButtonVisibility();
  }

  // 운동 선택 초기화 함수 (모달 열릴때 호출)
  function resetSelectedWorkout() {
    selectedWorkout = null; // 선택한 운동 초기화
  }

  // 저장 버튼 가시성
  function updateSaveButtonVisibility() {
    const saveButton = document.getElementById('saveWorkout');
    if (workoutId > 0) {
      saveButton.style.display = 'inline-block'; // 버튼 보이기
    } else {
      saveButton.style.display = 'none'; // 버튼 숨기기
    }
  }

  // 운동 그룹 생성
  function createWorkoutGroup(workoutId, selectedWorkout) {
    const newGroup = document.createElement('div');
    newGroup.classList.add('workout-group');
    newGroup.id = `workout-group-${workoutId}`;
    newGroup.setAttribute('data-workout-id', workoutId);
    newGroup.innerHTML = `
            <div class="workout-header" style="display: flex; align-items: center;">
                <div class="workout-title" style="margin-right: auto;">${selectedWorkout}</div>
                <input type="hidden" name="workouts[${
            workoutId - 1
    }].workout_name" value="${selectedWorkout}"/>
                <button type="button" class="btn btn-danger btn-remove" onclick="removeWorkout(this)">x</button>
            </div>
            <div class="set-header set-row">
                <div style="width: 100px;">세트</div>
                <div style="width: 100px;">중량</div>
                <div style="width: 100px;">횟수</div>
                <div style="width: 100px;"></div>
            </div>
            <div class="set-container"></div> <!-- 세트 컨테이너 추가 -->
            <button type="button" class="btn btn-link btn-add" onclick="addSet(this)">세트 추가</button>
        `;
    return newGroup;
  }

  // 운동 제거

  // workoutId 갱신
  function updateWorkoutId(workoutGroupId) {
    const workoutGroups = document.querySelectorAll('.workout-group');
    // workout-group-id 업데이트
    for (let i = 0; i < workoutGroups.length; i++) {
      const workoutGroup = workoutGroups[i];
      workoutGroup.setAttribute('data-workout-id', i + 1);
      workoutGroup.setAttribute('id', `workout-group-${i + 1}`);
    }
    workoutId--;
  }

  // workoutInput 갱신
  function updateWorkoutInput(workoutGroup) {
    const setRows = workoutGroup.querySelectorAll('.set-row');
    const dataWorkoutId = workoutGroup.getAttribute('data-workout-id');
    const workoutHeaders = workoutGroup.querySelectorAll('.workout-header');

    for (let i = 0; i < workoutHeaders.length; i++) {
      const inputs = workoutHeaders[i].querySelectorAll('input');
      inputs.forEach((input) => {
        input.name = input.name.replace(/workouts\[\d+\]/, `workouts[${dataWorkoutId - 1}]`);
      });
    }

    for (let i = 0; i < setRows.length; i++) {
      const inputs = setRows[i].querySelectorAll('input');
      inputs.forEach((input) => {
        input.name = input.name.replace(/workoutSet\[\d+\]/, `workoutSet[${i - 1}]`);
        input.name = input.name.replace(/workouts\[\d+\]/, `workouts[${dataWorkoutId - 1}]`);
      });
    }
  }

  // 모든 workoutInput 갱신
  function updateAllWorkoutInputs() {
    const workoutGroups = document.querySelectorAll('.workout-group');
    workoutGroups.forEach((workoutGroup) => {
      updateWorkoutInput(workoutGroup);
    });
  }

  // 세트 번호 갱신
  function updateSetNumbers(setContainer) {
    const setRows = setContainer.querySelectorAll('.set-row');
    setRows.forEach((row, index) => {
      row.querySelector('div').textContent = index + 1; // 세트 번호 업데이트
    });
  }

  // 세트 추가
  function addSet(button) {
    const workoutGroup = button.closest('.workout-group');
    const workoutId = workoutGroup.getAttribute('data-workout-id');
    const setContainer = button.previousElementSibling; // set-container를 찾음

    if (!setContainer) {
      console.error('setContainer가 없습니다.');
      return;
    }

    const setRow = createSetRow(workoutId, setContainer.children.length + 1);
    setContainer.appendChild(setRow);

    updateSetDeleteButtonVisibility();
  }

  // 세트 행 생성
  function createSetRow(workoutId, setNumber) {
    const setRow = document.createElement('div');
    setRow.classList.add('set-row');
    setRow.innerHTML = `
          <div style="width: 100px;">${setNumber}</div>
          <input type="number" class="form-control"  name="workouts[${
            workoutId - 1
    }].workoutSet[${setNumber - 1}].weight" required min="0" placeholder="kg" style="width: 100px; text-align: right;">
          <input type="number" class="form-control"  name="workouts[${
            workoutId - 1
    }].workoutSet[${setNumber - 1}].reps" required min="0" placeholder="회" style="width: 100px; text-align: right;">
          <button type="button" class="btn btn-danger btn-remove" onclick="removeSet(this)">세트 제거</button>
      `;
    return setRow;
  }

  // 세트 제거
  function removeSet(button) {
    const setRow = button.parentElement; // 버튼의 부모 요소인 세트 행을 가져옴
    const setContainer = setRow.parentElement; // 세트 행의 부모 요소인 세트 컨테이너를 가져옴
    const workoutGroup = button.closest('.workout-group');

    setRow.remove(); // 세트 행 제거
    updateSetNumbers(setContainer); // 남아 있는 세트의 번호 업데이트
    updateWorkoutInput(workoutGroup);
    updateSetDeleteButtonVisibility(); // 세트 제거버튼의 표시 상태 업데이트
  }

  // 세트 제거버튼 표시
  function updateSetDeleteButtonVisibility() {
    const workoutGroups = document.querySelectorAll('#workout-container .workout-group');

    workoutGroups.forEach((workoutGroup) => {
      const setContainer = workoutGroup.querySelector('.set-container');
      const removeButtons = setContainer.querySelectorAll('.btn-remove');

      removeButtons.forEach((button) => {
        if (setContainer.children.length <= 1) {
          button.style.visibility = 'hidden'; // 1 세트 이하일 경우 세트삭제 버튼 숨기기
        } else {
          button.style.visibility = 'visible'; // 2 세트 이상일 경우 세트삭제 버튼 보이기
        }
      });
    });
  }

  // 루틴 이름 입력받고 저장
  function confirmRoutineName() {
    const routineName = prompt('루틴의 이름을 입력하세요');

    if (routineName) {
      const routineNameInput = document.createElement('input');
      routineNameInput.type = 'hidden';
      routineNameInput.name = 'routine_name';
      routineNameInput.value = routineName;
      document.getElementById('routine-form').appendChild(routineNameInput);
      return true; // 폼 제출
    } else {
      alert('루틴 이름을 입력해야 합니다.');
      return false; // 폼 제출 방지
    }
  }
</script>

<!-- Popper.js 및 Bootstrap JS 추가 -->
<script th:src="@{/popper.min.js}"></script>
<script th:src="@{/bootstrap.min.js}"></script>
</body>
</html>